/*
 * Amaru Official Generic Malware Detection Rules
 * Description: Rules for detecting common malware patterns and behaviors
 * Author: Amaru Contributors
 * License: GPL-2.0
 */

rule Malware_Generic_Suspicious_PE {
    meta:
        description = "Detects suspicious PE file characteristics"
        author = "Amaru Project"
        reference = "https://www.virustotal.com/"
        confidence = "medium"
        severity = "medium"
    
    strings:
        $mz = { 4D 5A }
        $pe = { 50 45 00 00 }
        
        $s1 = "This program cannot be run in DOS mode" wide ascii
        
        $sus_section1 = ".text" wide ascii
        $sus_section2 = ".UPX" wide ascii
        $sus_section3 = ".ndata" wide ascii
        $sus_section4 = ".packed" wide ascii
        $sus_section5 = ".encr" wide ascii
        
        $packer1 = "UPX" nocase wide ascii
        $packer2 = "Enigma" nocase wide ascii
        $packer3 = "ASPack" nocase wide ascii
        $packer4 = "FSG" nocase wide ascii
        $packer5 = "Themida" nocase wide ascii
        $packer6 = "Armadillo" nocase wide ascii
        $packer7 = "VMProtect" nocase wide ascii
        
        $api1 = "VirtualAlloc" wide ascii
        $api2 = "VirtualProtect" wide ascii
        $api3 = "CreateRemoteThread" wide ascii
        $api4 = "WriteProcessMemory" wide ascii
        $api5 = "CreateProcess" wide ascii
        $api6 = "ReadProcessMemory" wide ascii
        $api7 = "LoadLibrary" wide ascii
        $api8 = "GetProcAddress" wide ascii
        $api9 = "SetWindowsHook" wide ascii
        $api10 = "MapViewOfFile" wide ascii
        
    condition:
        $mz at 0 and $pe and
        filesize < 10MB and 
        ((5 of ($api*)) or
         (1 of ($packer*) and 3 of ($api*)) or
         (2 of ($sus_section*) and 2 of ($api*)))
}

rule Malware_Generic_Keylogger {
    meta:
        description = "Detects keylogger functionality"
        author = "Amaru Project"
        reference = "https://www.virustotal.com/"
        confidence = "medium"
        severity = "high"
    
    strings:
        $mz = { 4D 5A }
        
        $api1 = "GetAsyncKeyState" wide ascii
        $api2 = "GetKeyboardState" wide ascii
        $api3 = "SetWindowsHookEx" wide ascii
        $api4 = "WH_KEYBOARD" wide ascii
        $api5 = "WH_KEYBOARD_LL" wide ascii
        $api6 = "keybd_event" wide ascii
        $api7 = "MapVirtualKey" wide ascii
        
        $str1 = "keyboard" nocase wide ascii
        $str2 = "keylog" nocase wide ascii
        $str3 = "key.log" nocase wide ascii
        $str4 = "typed" nocase wide ascii
        $str5 = "hook" nocase wide ascii
        $str6 = "keystroke" nocase wide ascii
        
    condition:
        $mz at 0 and
        filesize < 5MB and 
        ((3 of ($api*)) or
         (2 of ($api*) and 2 of ($str*)))
}

rule Malware_Generic_Persistence {
    meta:
        description = "Detects persistence mechanisms"
        author = "Amaru Project"
        reference = "https://www.virustotal.com/"
        confidence = "medium"
        severity = "medium"
    
    strings:
        $mz = { 4D 5A }
        
        $reg1 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase wide ascii
        $reg2 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase wide ascii
        $reg3 = "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase wide ascii
        $reg4 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase wide ascii
        $reg5 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase wide ascii
        $reg6 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase wide ascii
        
        $api1 = "RegSetValueEx" wide ascii
        $api2 = "RegCreateKeyEx" wide ascii
        $api3 = "RegOpenKeyEx" wide ascii
        $api4 = "CreateService" wide ascii
        $api5 = "StartService" wide ascii
        $api6 = "schtasks" wide ascii
        $api7 = "WMI" wide ascii
        
        $path1 = "\\Startup\\" nocase wide ascii
        $path2 = "\\AppData\\Roaming\\" nocase wide ascii
        $path3 = "\\ProgramData\\" nocase wide ascii
        $path4 = "\\system32\\" nocase wide ascii
        $path5 = "\\syswow64\\" nocase wide ascii
        
    condition:
        $mz at 0 and
        filesize < 5MB and 
        ((1 of ($reg*) and 2 of ($api*)) or
         (2 of ($reg*)) or
         (3 of ($api*) and 1 of ($path*)))
}

rule Malware_Generic_Stealer {
    meta:
        description = "Detects credential stealing functionality"
        author = "Amaru Project"
        reference = "https://www.virustotal.com/"
        confidence = "medium"
        severity = "high"
    
    strings:
        $mz = { 4D 5A }
        
        $browser1 = "chrome" nocase wide ascii
        $browser2 = "firefox" nocase wide ascii
        $browser3 = "opera" nocase wide ascii
        $browser4 = "safari" nocase wide ascii
        $browser5 = "edge" nocase wide ascii
        $browser6 = "iexplore" nocase wide ascii
        
        $file1 = "Login Data" wide ascii
        $file2 = "Cookies" wide ascii
        $file3 = "Web Data" wide ascii
        $file4 = "logins.json" wide ascii
        $file5 = "signons.sqlite" wide ascii
        $file6 = "key3.db" wide ascii
        $file7 = "key4.db" wide ascii
        
        $str1 = "password" nocase wide ascii
        $str2 = "credential" nocase wide ascii
        $str3 = "login" nocase wide ascii
        $str4 = "account" nocase wide ascii
        $str5 = "wallet" nocase wide ascii
        $str6 = "crypto" nocase wide ascii
        $str7 = "bitcoin" nocase wide ascii
        $str8 = "ethereum" nocase wide ascii
        
    condition:
        $mz at 0 and
        filesize < 5MB and 
        ((2 of ($browser*) and 1 of ($file*)) or
         (1 of ($browser*) and 2 of ($file*)) or
         (2 of ($browser*) and 3 of ($str*)) or
         (3 of ($file*) and 2 of ($str*)))
}

rule Malware_Generic_RAT {
    meta:
        description = "Detects Remote Access Trojan functionality"
        author = "Amaru Project"
        reference = "https://www.virustotal.com/"
        confidence = "medium"
        severity = "high"
    
    strings:
        $mz = { 4D 5A }
        
        $api1 = "WinExec" wide ascii
        $api2 = "ShellExecute" wide ascii
        $api3 = "CreateProcess" wide ascii
        $api4 = "socket" wide ascii
        $api5 = "connect" wide ascii
        $api6 = "recv" wide ascii
        $api7 = "send" wide ascii
        $api8 = "bind" wide ascii
        $api9 = "listen" wide ascii
        $api10 = "accept" wide ascii
        
        $cmd1 = "cmd.exe" nocase wide ascii
        $cmd2 = "powershell" nocase wide ascii
        $cmd3 = "cmd /c" nocase wide ascii
        $cmd4 = "-e" nocase wide ascii
        $cmd5 = "bypass" nocase wide ascii
        
        $str1 = "remote" nocase wide ascii
        $str2 = "server" nocase wide ascii
        $str3 = "client" nocase wide ascii
        $str4 = "backdoor" nocase wide ascii
        $str5 = "rat" nocase wide ascii
        $str6 = "keylog" nocase wide ascii
        $str7 = "screenshot" nocase wide ascii
        $str8 = "camera" nocase wide ascii
        $str9 = "spy" nocase wide ascii
        
    condition:
        $mz at 0 and
        filesize < 10MB and 
        ((4 of ($api*) and 1 of ($cmd*)) or
         (3 of ($api*) and 2 of ($str*)) or
         (2 of ($api*) and 1 of ($cmd*) and 2 of ($str*)))
} 